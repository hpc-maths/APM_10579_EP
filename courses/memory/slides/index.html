<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/theme/dark.css" id="theme">
  <link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
  rel="stylesheet"
  integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
  crossorigin="anonymous">

  <title>MAP579 - Memory and pointers</title>
</head>

<body>
  <div class="reveal">
    <div class="slides">

      <section class="title-section">
        <h1>
          Memory and pointers
        </h1>
        <h2>
          MAP 579
        </h2>
      </section>

      <section>
        <section>
          <div class="sl-block">
            <div class="header">
              <h1 class="title">
                Storage types
              </h1>
            </div>
            <div class="main">

              <ul>
                <li>
                  static storage
                </li>
                <li>
                  thread-local storage
                </li>
                <li>
                  automatic storage
                </li>
                <li>
                  dynamic storage
                </li>
              </ul>
            </div>
          </div>
        </section>

        <section>
          <div class="sl-block">
            <div class="header">
              <h1 class="title">
                Static storage
              </h1>
            </div>
            <div class="main">

              <ul>
                <li>
                  fixed address determined at compile time
                </li>
                <li>
                  global static variables are
                  <ul>
                    <li>constructed before execution enters main</li>
                    <li>
                      deleted after execution leaves main
                    </li>
                  </ul>

                </li>
                <li>
                  static variables in a scope are constructed before the execution
                  of this scope.
                </li>
                <li>
                  the order of construction is complex
                </li>
                <li>
                  no runtime cost to create the storage
                </li>
              </ul>
              <p class="text-center fragment"><strong>appropriate for data that
                will be used for the whole life of the program</strong>
              </p>
            </div>
          </div>
        </section>

        <section>
          <div class="sl-block">
            <div class="header">
              <h1 class="title">
                Automatic storage
              </h1>
            </div>
            <div class="main">

              <ul>
                <li>
                  memory reserved by the compiler (stack)
                </li>
                <li>
                  exists into their scope
                </li>
                <li>
                  deleted when they leave the scope
                </li>
                <li>
                  limit to the total amount of memory in the stack
                </li>
              </ul>
            </div>
          </div>
        </section>

        <section>
          <div class="sl-block">
            <div class="header">
              <h1 class="title">
                Dynamic storage
              </h1>
            </div>
            <div class="main">

              <ul>
                <li>
                  memory requested at runtime (heap)
                </li>
                <li>
                  must be explicitly requested (new)
                </li>
                <li>
                  must be explicitly destroyed (delete)
                </li>
                <li>
                  the address is determined at runtime
                </li>
                <li>
                  no limit to the total amount of memory
                </li>
              </ul>
            </div>
          </div>
        </section>

        <section>
          <div class="sl-block">
            <div class="header">
              <h1 class="title">
                static pitfalls
              </h1>
            </div>
            <div class="main">

            </div>
          </div>
        </section>

        <section>
          <div class="sl-block">
            <div class="header">
              <h1 class="title">
                static pitfalls: step 0
              </h1>
            </div>
            <div class="main">


              <div class="text-center">
                <p>Open the <strong>static</strong> directory.</p>
                <p>What kind of variable is <strong>r</strong> ?</p>
              </div>
            </div>
          </div>
        </section>

        <section>
          <div class="sl-block">
            <div class="header">
              <h1 class="title">
                static pitfalls: step 1
              </h1>
            </div>
            <div class="main">

              <div class="text-center">
                <p>Make <strong>r</strong> static.</p>
                <p>What do you observe ?</p>
              </div>
            </div>
          </div>
        </section>

        <section>
          <div class="sl-block">
            <div class="header">
              <h1 class="title">
                static pitfalls: step 2
              </h1>
            </div>
            <div class="main">

              <div class="text-center">
                <p>Initialize <strong>m_count</strong> to 10 in the resource
                  class.
                </p>
                <p>Make <strong>m</strong> static and <strong>r</strong> a static
                  member of manager class.
                </p>
                <p>Create a <strong>print()</strong> function in manager class
                  which prints <i>Hello manager</i> and acquire the resource.
                </p>
                <p>What do you observe ?
                </p>
              </div>
            </div>
          </div>
        </section>

        <section>
          <div class="sl-block">
            <div class="header">
              <h1 class="title">
                static pitfalls: step 3
              </h1>
            </div>
            <div class="main">
              <div class="text-center">
                <p>Remove the static member to the resource.</p>
                <p>Create a function class which returns a reference to a static
                  resource created in this function.</p>
                  <p>Use this function when you want to acquire the resource.
                  </p>
                </div>
              </div>
            </div>
          </section>
        </section>

        <section>
          <section>
            <div class="sl-block">
              <div class="header">
                <h1 class="title">
                  Pointer
                </h1>
              </div>
              <div class="main">
                <p>A pointer variable is a variable which stores a memory address.</p>
                <p>A pointer variable must be assigned to be used.</p>
              </div>
            </div>
          </section>

          <section>
            <div class="sl-block">
              <div class="header">
                <h1 class="title">
                  Pointer: example
                </h1>
              </div>
              <div class="main">
                <pre>
                  <code class="cpp">
double d = 0.5;
double* p = &amp;d;
float* p_f = nullptr;

std::cout &lt;&lt; d &lt;&lt; std::endl;
std::cout &lt;&lt; *p &lt;&lt; std::endl;
std::cout &lt;&lt; p &lt;&lt; std::endl;

std::cout &lt;&lt; p_f &lt;&lt; std::endl;
std::cout &lt;&lt; *p_f &lt;&lt; std::endl; // Error: segfault

int i = 4;
double* p2 = &amp;i; // Error: cannot convert from int* to double*
                  </code>
                </pre>
              </div>
            </div>
          </section>

          <section>
            <div class="sl-block">
              <div class="header">
                <h1 class="title">
                  Pointer: cast
                </h1>
              </div>
              <div class="main">

                <pre>
                  <code class="cpp">
int i = 4;
int* pi = &amp;i;
// double* d = (double*)pi;
double* d = reinterpret_cast&lt;double*&gt;(pi);
std::cout &lt;&lt; i &lt;&lt; std::endl;
std::cout &lt;&lt; pi &lt;&lt; std::endl;
std::cout &lt;&lt; d &lt;&lt; std::endl;
std::cout &lt;&lt; *pi &lt;&lt; std::endl;
std::cout &lt;&lt; *d &lt;&lt; std::endl;
                  </code>
                </pre>
              </div>
            </div>
          </section>

          <section>
            <div class="sl-block">
              <div class="header">
                <h1 class="title">
                  Pointer: new and delete
                </h1>
              </div>
              <div class="main">

                <pre>
                  <code class="cpp">
int* i = new int;     // allocates an uninitialized integer
int* i2 = new int(5); // allocates an integer initialized to 5
int* i3 = new int[5]; // allocates an array of 5 integers

delete[] i3;          // free the memory used by the array i3
delete i2;            // free the memory used by i2
delete i;             // free the memory used by i
                  </code>
                </pre>
              </div>
            </div>
          </section>

          <section>
            <p class="text-center">How to allocate and deallocate properly a
              <strong>double**</strong>
            </p>
            <p class="text-center">with <strong>nx</strong> rows and
              <strong>ny</strong> columns.
            </p>
          </section>

          <section>
            <div class="sl-block">
              <div class="header">
                <h1 class="title">
                  Pointer: struct or class
                </h1>
              </div>
              <div class="main">

                <pre>
                  <code class="cpp">
struct A
{
  double x;
  double y;
};

A* a = new A;

std::cout &lt;&lt; (*a).x &lt;&lt; std::endl;
// or
std::cout &lt;&lt; a->x &lt;&lt; std::endl;

delete a;
                  </code>
                </pre>
              </div>
            </div>
          </section>

          <section>
            <div class="sl-block">
              <div class="header">
                <h1 class="title">
                  Pointer: arithmetic
                </h1>
              </div>
              <div class="main">

                <pre><code class="cpp">
int* ar = new int[10];
// Or
std::vector&lt;int&gt; v(10);
int* ar = v.data();
                </code></pre>
                <pre class="fragment"><code class="cpp">
int* ar2 = ar + 2;
std::cout &lt;&lt; *ar2 &lt;&lt; std::endl;
std::cout &lt;&lt; ar[2] &lt;&lt; std::endl;
std::cout &lt;&lt; (ar2 - ar) &lt;&lt; std::endl;

int* ar3 = ar2 - 1;
std::cout &lt;&lt; *ar3 &lt;&lt; std::endl;
std::cout &lt;&lt; ar[1] &lt;&lt; std::endl;
                </code></pre>
              </div>
            </div>
          </section>

          <section>
            <p class="text-center">Implement the palindrome algortihm using two
              pointers.
            </p>
            <p class="text-center">The string will be stored in an <code
              class="cpp">std::string</code>.
            </p>
          </section>
        </section>

        <section>
          <section>
            <div class="sl-block">
              <div class="header">
                <h1 class="title">
                  Exceptions
                </h1>
              </div>
              <div class="main">

                <pre><code class="cpp">
void mean(const std::vector&lt;double&gt;&amp; param)
{
  if(param.size() == 0)
  {
    throw std::runtime_error("param size is 0")
  }
  else
  {
    // ...
  }
}
                </code></pre>
              </div>
            </div>
          </section>

          <section>
            <div class="sl-block">
              <div class="header">
                <h1 class="title">
                  Exceptions
                </h1>
              </div>
              <div class="main">

                <pre><code class="cpp">
try
{
  std::vector&lt;double&gt; v(0);
  mean(v);
}
catch(std::exception&amp; e)
{
  std::cout &lt;&lt; "caught exception - " &lt;&lt; e.what() &lt;&lt; std::endl;
}
                </code></pre>
              </div>
            </div>
          </section>

          <section>
            <p class="text-center">Try to compile the example found in the <strong>exception</strong> directory
            </p>
            <p class="text-center">and fix it.
            </p>
          </section>

          <section>
            <div class="sl-block">
              <div class="header">
                <h1 class="title">
                  Exceptions
                </h1>
              </div>
              <div class="main">

                <pre><code class="cpp">
void test_resource()
{
  resource r;
  try
  {
    r.acquire();
    if (...)
    {
      r.release();
      return;
    }
    r.print_message();
    r.release();
  }
  catch(std::exception&amp; e)
  {
    std::cout &lt;&lt; "exception caught: " &lt;&lt; e.what() &lt;&lt; std::endl;
    r.release();
  }
}
                </code></pre>
                <p class="text-center">What do you think about this code ?</p>
              </div>
            </div>
          </section>

          <section>
            <div class="text-center">
              <img src="./figures/RAII_1.png" width="80%" />
              <p><i>Extract from the talk of Arthur O'Dwyer at CppCon 2019</i></p>
            </div>
          </section>

          <section>
            <div class="text-center">
              <img src="./figures/RAII_2.png" width="80%" />
              <p><i>Extract from the talk of Arthur O'Dwyer at CppCon 2019</i></p>
            </div>
          </section>

          <section>
            <div class="sl-block">
              <div class="header">
                <h1 class="title">
                  Exceptions - RAII
                </h1>
              </div>
              <div class="main">

                <pre><code class="cpp">
void test_resource()
{
  resource r;
  resource_guard g(r);
  r.print_message();
}
                </code></pre>
                <p class="text-center">Write what <strong>resource_guard</strong>
                  should do.
                </p>
              </div>
            </div>
          </section>

          <section>
            <div class="sl-block">
              <div class="header">
                <h1 class="title">
                  Exceptions - RAII
                </h1>
              </div>
              <div class="main">

                <pre><code class="cpp">
class resource_guard
{
  public:

    resource_guard(resource&amp; r);
    ~resource_guard();

  private:

    resource&amp; m_r;
};
                </code></pre>
              </div>
            </div>
          </section>

          <section>
            <div class="sl-block">
              <div class="header">
                <h1 class="title">
                  Exceptions - RAII
                </h1>
              </div>
              <div class="main">

                <pre><code class="cpp">
resource_guard::resource_guard(resource&amp; r)
: m_r(r)
{
  m_r.acquire();
}

resource::~resource_guard()
{
  m_r.release();
}
                </code></pre>
              </div>
            </div>
          </section>

          <section>
            <div class="sl-block">
              <div class="header">
                <h1 class="title">
                  Exceptions - noexcept
                </h1>
              </div>
              <div class="main">

                <pre><code class="cpp">
void function() noexcept;
                </code></pre>
                <div class="fragment">
                  <p>The <strong>noexcept</strong> keyword</p>
                  <ul>
                    <li>is part of the signature</li>
                    <li>tells the compiler that the function does not raise</li>
                    <li>the compiler does not check the validity of noexcept</li>
                    <li>is mainly used for performance purpose</li>
                  </ul>
                </div>
              </div>
            </div>
          </section>
        </section>

        <section>
          <section>
            <div class="sl-block">
              <div class="header">
                <h1 class="title">
                  Memory Management
                </h1>
              </div>
              <div class="main">

                Who is the owner of this return type ?
                <pre><code class="cpp">
Result* make_computation(class_A& a, class_B& b);
                </code></pre>
              </div>
            </div>
          </section>

          <section>
            <div class="sl-block">
              <div class="header">
                <h1 class="title">
                  Memory Management
                </h1>
              </div>
              <div class="main">

                It could be
                <pre><code class="cpp">
Result* make_computation(class_A& a, class_B& b)
{
  Result* r = new Result();
  ...
  return r;
}
                </code></pre>
                <p class="fragment" data-fragment-index="0">or</p>
                <pre class="fragment" data-fragment-index="0"><code class="cpp">
Result* make_computation(class_A& a, class_B& b)
{
  ...
  return a.get_result(b);
}
                </code></pre>
              </div>
            </div>
          </section>

          <section>
            <div class="sl-block">
              <div class="header">
                <h1 class="title">
                  Memory Management
                </h1>
              </div>
              <div class="main">

                <p>The owner of a resource should be readable and obvious when you
                  read the source code.
                </p>
                <p>This makes it clear who is reponsible for the destruction of the
                  data and to avoid potential memory leakage.
                </p>
              </div>
            </div>
          </section>

          <section>
            <div class="sl-block">
              <div class="header">
                <h1 class="title">
                  Memory Management
                </h1>
              </div>
              <div class="main">

                <p>Smart pointers help to specify the ownership.</p>

                <p>There are two versions:</p>
                <ul>
                  <li><code>std::unique_ptr</code>: unique ownership</li>
                  <li><code>std::shared_ptr</code>: shared ownership</li>
                </ul>
              </div>
            </div>
          </section>

          <section>
            <div class="sl-block">
              <div class="header">
                <h1 class="title">
                  <code>std::unique_ptr</code>
                </h1>
              </div>
              <div class="main">

                <pre><code class="cpp">
class coord
{
  public:
    coord(double x, double y)
    : m_x(x), m_y(y)
    {}

    void print() const
    {
      std::cout &lt;&lt; "coords(" &lt;&lt; m_x &lt;&lt; ", " &lt;&lt; m_y &lt;&lt; ")" &lt;&lt; std::endl;
    }

  private:
    double m_x, m_y;
};
                </code></pre>
              </div>
            </div>
          </section>

          <section>
            <div class="sl-block">
              <div class="header">
                <h1 class="title">
                  <code>std::unique_ptr</code>
                </h1>
              </div>
              <div class="main">

                <pre><code class="cpp">
int main()
{
  auto p_1 = std::unique_ptr&lt;double&gt;(new double(4.));
  auto p_c = std::make_unique&lt;coord&gt;(4., 3.);
  auto p_a = std::unique_ptr&lt;double[]&gt;(new double[1000]);

  p_c->print();

  // auto p_2 = p_1; // Error: unique_ptr is not copyable
  auto p_2 = std::move(p_1);
  std::cout &lt;&lt; *p_2 &lt;&lt; std::endl;
  std::cout &lt;&lt; p_1 &lt;&lt; std::endl;
}
                </code></pre>
              </div>
            </div>
          </section>

          <section>
            <div class="sl-block">
              <div class="header">
                <h1 class="title">
                  <code>std::shared_ptr</code>
                </h1>
              </div>
              <div class="main">

                <pre><code class="cpp">
std::shared_ptr&lt;int&gt; p = new int;
std::shared_ptr&lt;int&gt; p2(new int);
auto p3 = std::make_shared&lt;int&gt;();
                </code></pre>

                <pre class="fragment"><code class="cpp">
void function()
{
  auto p = std::make_shared&lt;int&gt;(); // ref_count = 1;
  {
    std::shared_ptr&lt;int&gt; p2 = p; // ref_count = 2;
    // ...
  } // p2 destructor is called, ref_count = 1
} // p destructor is called, ref_count = 0, deletes the internal pointer
                </code></pre>
                <p class="text-center fragment"><i>to be used with caution because it is expensive !</i></p>
              </div>
            </div>
          </section>
        </section>
        <section>
          <div class="sl-block">
            <div class="header">
              <h1 class="title">
                References
              </h1>
            </div>
            <div class="main">
              <ul>
                <li>
                  <a href="https://alp.developpez.com/faq/cpp/?page=static#:~:text=Le%20fiasco%20dans%20l'ordre,l'ex%C3%A9cution%20du%20main()">Les données et fonctions membres statiques</a>
                </li>
                <li>
                  <a href="https://www.amazon.fr/Optimized-C-Kurt-Guntheroth/dp/1491922060">Optimized C++</a> chapter 6
                </li>
                <li>
                  <a href="https://github.com/CppCon/CppCon2019/blob/master/Presentations/back_to_basics_raii_and_the_rule_of_zero/back_to_basics_raii_and_the_rule_of_zero__arthur_odwyer__cppcon_2019.pdf">Back to Basics: RAII and the Rule of Zero</a> at CppCon 2019
                </li>
                <li>
                  <a href="https://github.com/CppCon/CppCon2019/blob/master/Presentations/back_to_basics_smart_pointers/back_to_basics_smart_pointers__arthur_odwyer__cppcon_2019.pdf">Back to Basics: Smart Pointers</a> at CppCon 2019
                </li>
              </ul>
            </div>
          </div>
        </section>
      </div>
    </div>
    <script type="module" src="/main.js"></script>
  </body>

  </html>